<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üì¨ Paperboy Max üö≤</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #ecf0f1;
    }

    header {
      padding: 16px;
      background: #fff;
      text-align: center;
    }

    #map {
      height: 300px;
      width: 100%;
    }

    .group {
      padding: 16px;
      background: #fff;
      margin-top: 10px;
    }

    .group ul {
      list-style: none;
      padding: 0;
    }

    .group li {
      margin-bottom: 8px;
    }

    .group button {
      margin-left: 8px;
      background-color: #2ecc71;
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    .gamification {
      background: #fff;
      padding: 16px;
    }

    .progress-container {
      position: relative;
      height: 40px;
      background: transparent;
      border-radius: 16px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-bar {
      height: 100%;
      background: #3498db;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 16px;
    }

    .bike-icon {
      position: absolute;
      top: 50%;
      transform: translateY(-50%) scaleX(-1);
      left: 0%;
      transition: left 0.3s ease;
      font-size: 1.5em;
    }

    nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      display: flex;
      background: #fff;
      border-top: 1px solid #ccc;
    }

    nav button {
      flex: 1;
      padding: 12px;
      font-size: 1.2em;
      background: none;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<header>
  <h1>üì¨ Paperboy Max üö≤</h1>
</header>

<div id="map"></div>

<div class="group" id="addressGroup"></div>

<div class="gamification">
  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
    <div class="bike-icon" id="bike" style="left: 0%;">üö≤</div>
  </div>
</div>

<nav>
  <button onclick="location.href='index.html'">üè†</button>
  <button onclick="location.href='map.html'">üó∫Ô∏è</button>
  <button onclick="location.href='end.html'">‚úÖ</button>
</nav>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const API_KEY = "5b3ce3597851110001cf62484bec1b24cbf740958a710da8b4b95e76";
  const map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  const addresses = localStorage.getItem('addresses')?.split('\n') || [];
  const types = localStorage.getItem('types')?.split(',') || [];
  const groupSize = 4;
  let currentGroup = 0;
  let xp = 0;

  async function geocode(address) {
    const fullAddress = `${address}, Mierlo, Nederland`;
    const url = `https://api.openrouteservice.org/geocode/search?api_key=${API_KEY}&text=${encodeURIComponent(fullAddress)}`;
    const res = await fetch(url);
    const data = await res.json();
    const [lon, lat] = data.features[0].geometry.coordinates;
    return { address, lat, lon };
  }

  async function loadGroup() {
    const group = addresses.slice(currentGroup * groupSize, (currentGroup + 1) * groupSize);
    const groupHTML = [];
    map.eachLayer(l => l instanceof L.Marker && map.removeLayer(l));
    const bounds = [];

    for (let i = 0; i < group.length; i++) {
      const addr = group[i];
      const label = types[(currentGroup * groupSize) + i];
      const { lat, lon } = await geocode(addr);
      bounds.push([lat, lon]);
      L.marker([lat, lon]).addTo(map).bindPopup(`${label} ${addr}`);
      const color = label === "FK" ? "red" : "green";
      groupHTML.push(`<li><span style="color:${color}; font-weight:bold;">${label}</span> ${addr} <button onclick="completeAddress(this)">‚úÖ</button></li>`);
    }

    document.getElementById('addressGroup').innerHTML = `<ul>${groupHTML.join('')}</ul>`;

    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [30, 30] });
    }
  }

  function completeAddress(btn) {
    btn.disabled = true;
    xp += 10;

    const total = addresses.length;
    const progress = Math.min((xp / (total * 10)) * 100, 100);
    document.getElementById('progressBar').style.width = progress + "%";
    document.getElementById('bike').style.left = progress + "%";

    const remaining = document.querySelectorAll('#addressGroup button:not([disabled])').length;

    if (remaining === 0) {
      if ((currentGroup + 1) * groupSize < addresses.length) {
        currentGroup++;
        loadGroup();
      } else {
        window.location.href = 'end.html';
      }
    }
  }

  loadGroup();
</script>

</body>
</html>
