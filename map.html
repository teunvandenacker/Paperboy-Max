<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸ“¬ Paperboy Max - Kaart</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+4hF3QWhS5E95tV0CyN4WmvB5h3Q1v/2JM9y+jw6o="
    crossorigin=""
  />
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #ecf0f1;
      color: #2c3e50;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 15px 20px;
      background: #3498db;
      color: white;
      font-size: 1.8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      user-select: none;
    }
    #map {
      flex: 1;
      min-height: 300px;
    }
    .address-list {
      background: white;
      max-height: 220px;
      overflow-y: auto;
      padding: 10px 20px;
      box-shadow: 0 -3px 10px rgba(0,0,0,0.1);
      font-size: 1rem;
    }
    .address-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 10px;
    }
    .address-item {
      background: #3498db;
      color: white;
      padding: 10px 14px;
      border-radius: 12px;
      flex: 1 1 calc(50% - 20px);
      max-width: calc(50% - 20px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 3px 6px rgba(52,152,219,0.4);
      user-select: none;
    }
    .address-item.completed {
      background: #2ecc71;
      text-decoration: line-through;
      color: #eee;
      box-shadow: 0 3px 6px rgba(46,204,113,0.6);
    }
    .address-text {
      flex-grow: 1;
      padding-right: 10px;
      font-weight: 600;
    }
    button.complete-btn {
      background: #e74c3c;
      border: none;
      border-radius: 8px;
      color: white;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 700;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    button.complete-btn:hover:not(:disabled) {
      background-color: #c0392b;
    }
    button.complete-btn:disabled {
      background-color: #95a5a6;
      cursor: default;
    }
    .scoreboard {
      background: #3498db;
      color: white;
      font-weight: 700;
      padding: 12px 20px;
      font-size: 1.2rem;
      text-align: center;
      user-select: none;
    }
    @media (max-width: 480px) {
      .address-item {
        flex: 1 1 100%;
        max-width: 100%;
      }
      header {
        font-size: 1.4rem;
      }
      .scoreboard {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <header>ðŸ“¬ Paperboy Max ðŸš²</header>

  <div id="map"></div>

  <div class="address-list" id="addressList"></div>

  <div class="scoreboard" id="scoreboard">Afgerond: 0 / 0</div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j8lA77uFgoVfNhtzRkuybBuMJwpKw7GF3g7FZ8o="
    crossorigin=""
  ></script>
  <script>
    const ORS_API_KEY = '5b3ce3597851110001cf62484bec1b24cbf740958a710da8b4b95e76';

    // Init map, centered on Mierlo (coordinates approx)
    const map = L.map('map').setView([51.4381, 5.5758], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution:
        '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Load addresses from localStorage
    let addresses = [];
    try {
      addresses = JSON.parse(localStorage.getItem('paperboy_addresses')) || [];
    } catch {
      addresses = [];
    }

    if (addresses.length === 0) {
      alert('Geen adressen gevonden! Ga terug naar startpagina om adressen in te voeren.');
      window.location.href = 'index.html';
    }

    // Elements
    const addressListEl = document.getElementById('addressList');
    const scoreboardEl = document.getElementById('scoreboard');

    let currentGroupIndex = 0;
    let completedAddresses = new Set();
    let markers = [];

    // Geocode all addresses via ORS
    async function geocodeAddress(address) {
      const url = `https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(address)}&size=1`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.features && data.features.length > 0) {
          const coords = data.features[0].geometry.coordinates; // [lon, lat]
          return [coords[1], coords[0]];
        } else {
          console.warn('Geen locatie gevonden voor:', address);
          return null;
        }
      } catch (e) {
        console.error('Fout bij geocoderen:', e);
        return null;
      }
    }

    // Show addresses in groups of 4
    function renderAddressGroup() {
      addressListEl.innerHTML = '';
      const start = currentGroupIndex * 4;
      const group = addresses.slice(start, start + 4);
      if (group.length === 0) {
        addressListEl.innerHTML = '<em>Geen meer adressen.</em>';
        return;
      }

      group.forEach((address, i) => {
        const idx = start + i;
        const completed = completedAddresses.has(idx);

        const item = document.createElement('div');
        item.className = 'address-item' + (completed ? ' completed' : '');

        const text = document.createElement('div');
        text.className = 'address-text';
        text.textContent = address;
        item.appendChild(text);

        const btn = document.createElement('button');
        btn.textContent = completed ? 'âœ“' : 'Voltooid';
        btn.className = 'complete-btn';
        btn.disabled = completed;
        btn.addEventListener('click', () => {
          completedAddresses.add(idx);
          btn.disabled = true;
          item.classList.add('completed');

          // Update scoreboard
          updateScoreboard();

          // Zoom to next unfinished address marker if any
          zoomToNextPendingMarker();

          // If all completed and last in group, move to next group automatically
          if (group.every((_, i2) => completedAddresses.has(start + i2))) {
            if ((currentGroupIndex + 1) * 4 < addresses.length) {
              currentGroupIndex++;
              renderAddressGroup();
            }
          }
        });
        item.appendChild(btn);

        addressListEl.appendChild(item);
      });
    }

    function updateScoreboard() {
      scoreboardEl.textContent = `Afgerond: ${completedAddresses.size} / ${addresses.length}`;
    }

    function clearMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }

    async function setupMarkers() {
      clearMarkers();

      // Geocode all addresses and create markers
      const coordsList = [];
      for (let addr of addresses) {
        const coords = await geocodeAddress(addr);
        coordsList.push(coords);
      }

      // Filter out nulls
      coordsList.forEach((coords, i) => {
        if (!coords) return;

        const marker = L.marker(coords).addTo(map);
        marker.bindPopup(`<b>${addresses[i]}</b>`);
        markers.push(marker);
      });

      // Fit map bounds to all markers if any
      const validCoords = coordsList.filter(c => c !== null);
      if (validCoords.length > 0) {
        const bounds = L.latLngBounds(validCoords);
        map.fitBounds(bounds.pad(0.3));
      } else {
        // Fallback to Mierlo
        map.setView([51.4381, 5.5758], 15);
      }
    }

    function zoomToNextPendingMarker() {
      for (let i = 0; i < addresses.length; i++) {
        if (!completedAddresses.has(i) && markers[i]) {
          map.setView(markers[i].getLatLng(), 17, { animate: true });
          markers[i].openPopup();
          return;
        }
      }
      // No pending, zoom out to all
      const latlngs = markers.map(m => m.getLatLng());
      if (latlngs.length > 0) {
        map.fitBounds(L.latLngBounds(latlngs).pad(0.3));
      }
    }

    async function init() {
      updateScoreboard();
      await setupMarkers();
      renderAddressGroup();
      zoomToNextPendingMarker();
    }

    init();
  </script>
</body>
</html>
